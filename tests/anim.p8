pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
--stack-based movement system
--by hankdetank05

function _init()

	music(0)
	palt(0,false)
	palt(1,true)
	
	bpm=speed_to_bpm(16,4)
	bps=bpm_to_bps(bpm)
	bpf1=bps_to_bpf(bps)
	bpf2=bpm_to_bpf(bpm)
	bpf3=0.03125047
	
	beat=0

 chars={}
 colors={12,8,11,9}
 colrow={0,1,2,3}
 curr_colrow=0
 
 for i=1,#colors do
 	char=create_char(1,16*i,16*(i-1)+1)
 	add(chars,char)
 end
 
 cmds={
		{dir="⬅️",frames=60},
		{dir="⬆️",frames=60},
		{dir="➡️",frames=120},
		{dir="⬇️",frames=120},
		{dir="⬅️",frames=120},
		{dir="⬆️",frames=60},
		{dir="➡️",frames=60}
	}
	
	--[[chars[1].xpos=64
	chars[1].ypos=64
	chars[1].cmds=cmds--]]

end

function _update60()

	beat+=bpf3
	if beat>8 then
		beat-=8
		curr_colrow+=1
		if curr_colrow>3 then
			curr_colrow=0
		end
	end

	for i=1,#chars do
		char=chars[i]
	
		contains_⬅️=stack_contains(char.stack,"⬅️")
		contains_➡️=stack_contains(char.stack,"➡️")
		contains_⬆️=stack_contains(char.stack,"⬆️")
		contains_⬇️=stack_contains(char.stack,"⬇️")
	
		if "⬅️"==get_cmd(char.cmds,char.frm_ct) and not(contains_⬅️) then
			add(char.stack,"⬅️")
		elseif not(btn(⬅️)) and contains_⬅️ then
			del(char.stack,"⬅️")
		end
		
		if "➡️"==get_cmd(char.cmds,char.frm_ct) and not(contains_➡️) then
			add(char.stack,"➡️")
		elseif not(btn(➡️)) and contains_➡️ then
			del(char.stack,"➡️")
		end
		
		if "⬆️"==get_cmd(char.cmds,char.frm_ct) and not(contains_⬆️) then
			add(char.stack,"⬆️")
		elseif not(btn(⬆️)) and contains_⬆️ then
			del(char.stack,"⬆️")
		end
		
		if "⬇️"==get_cmd(char.cmds,char.frm_ct) and not(contains_⬇️) then
			add(char.stack,"⬇️")
		elseif not(btn(⬇️)) and contains_⬇️ then
			del(char.stack,"⬇️")
		end
		
		if #char.stack>0 then
			char.moving=true
		else
			char.moving=false
		end
		
		top=char.stack[#char.stack]
		
		if top=="⬅️" then
			if char.xpos>0 then
				char.xpos-=char.spd
			end
			char.curr_spr=char.sprites.⬅️
		elseif top=="➡️" then
			if char.xpos+char.size-2<127 then
				char.xpos+=char.spd
			end
			char.curr_spr=char.sprites.➡️
		elseif top=="⬆️" then
			if char.ypos>0 then
				char.ypos-=char.spd
			end
			char.curr_spr=char.sprites.⬆️
		elseif top=="⬇️" then
			if char.ypos+char.size-1<127 then
				char.ypos+=char.spd
			end
			char.curr_spr=char.sprites.⬇️
		end
		
		char.frm_ct+=1
	end

end

function _draw()

	cls(3)

	for i=1,#chars do
		local char=chars[i]
		spr(char.curr_spr,char.xpos,char.ypos)
	end
	
	for i=1,8 do
		if i!=ceil(beat) then
			spr(curr_colrow*16+6,(i-1)*16+1,1)
		else
			spr(curr_colrow*16+5,(i-1)*16+1,1)
		end
	end
	
	--[[print(bpm,0,0*6,11)
	print(bps,0,1*6,11)
	print(bpf1,0,2*6,11)
	print(bpf2,0,3*6,11)
	print(beat,0,4*6,11)--]]
	
end
-->8
--tab 1: stack util

function stack_contains(stack,str)
	
	if #stack==0 then
		return false
		
	else
		for i=1,#stack do
			if stack[i]==str then
				return true
			end
		end
	end
	
	return false
	
end
-->8
--tab 2: anim util

function create_char(x,y,spr_i)
	local char={
		xpos=x,
		ypos=y,
		spd=1,
		moving=false,
		curr_spr=spr_i,
		size=8,
		sprites={
			⬅️=spr_i,
			➡️=spr_i+1,
			⬆️=spr_i+2,
			⬇️=spr_i+3
		},
		frm_ct=0,
		cmds={},
		stack={}
	}
	return char
end

function get_cmd(cmds,frm_ct)
	local cmd_frame_count=0
	for i=1,#cmds do
		cmd_frame_count+=cmds[i].frames
		if frm_ct<cmd_frame_count then
			return cmds[i].dir
		end
	end
	return nil
end
-->8
--tab 3: music

--[[
bass drum = c 1?43
?	for more punchy sound, try
		different instrumnets

snare drum = c ?615
?	(start with 3) the higher the
		pitch, the more the sound
		will cut through everything
		else in the track

cymbal bell = d#5?15
?	(start with 2) try
		experimenting with the
		instrument, see what you like

cool sound = d#2?13
?	(start with 3) experiment
		with the instrument
--]]

function speed_to_bpm(spd,npb)
	--npb=notes per beat
	return 60/(spd/(120/npb))
end

function bpm_to_bps(bpm)
	--(beats/mins) * (mins/secs)
	return bpm*(1/60)
end

function bps_to_bpf(bps)
	--(beats/secs) * (secs/frame)
	return bps*((1/60)/60)
end

function bpm_to_bpf(bpm)
	--(beats/mins) * (mins/secs) * (secs/frames)
	return bpm * (1/60) * ((1/60)/60)
end
__gfx__
0000000011444411114444111144441111444411111ccc011111ccc1000000000000000000000000000000000000000000000000000000000000000000000000
000000001fff44411444fff11444444114ffff41111cccc01111cccc000000000000000000000000000000000000000000000000000000000000000000000000
007007001fcfff4114fffcf11f4444f11fcffcf1111cc0c01111cc1c000000000000000000000000000000000000000000000000000000000000000000000000
000770001ffffff11ffffff11ffffff11ffffff1111cc0111111cc11000000000000000000000000000000000000000000000000000000000000000000000000
0007700011ffff1111ffff1111ffff1111ffff111cccc01111cccc11000000000000000000000000000000000000000000000000000000000000000000000000
0070070011cccc1111cccc1111cccc1111cccc11ccccc0111ccccc11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011cfcc1111ccfc111fccccf11fccccf1ccccc0111ccccc11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011cccc1111cccc1111cccc1111cccc111ccc011111ccc111000000000000000000000000000000000000000000000000000000000000000000000000
00000000114444111144441111444411114444111118880111118881000000000000000000000000000000000000000000000000000000000000000000000000
000000001fff44411444fff11444444114ffff411118888011118888000000000000000000000000000000000000000000000000000000000000000000000000
000000001f8fff4114fff8f11f4444f11f8ff8f11118808011118818000000000000000000000000000000000000000000000000000000000000000000000000
000000001ffffff11ffffff11ffffff11ffffff11118801111118811000000000000000000000000000000000000000000000000000000000000000000000000
0000000011ffff1111ffff1111ffff1111ffff111888801111888811000000000000000000000000000000000000000000000000000000000000000000000000
00000000118888111188881111888811118888118888801118888811000000000000000000000000000000000000000000000000000000000000000000000000
00000000118f88111188f8111f8888f11f8888f18888801118888811000000000000000000000000000000000000000000000000000000000000000000000000
00000000118888111188881111888811118888111888011111888111000000000000000000000000000000000000000000000000000000000000000000000000
0000000011444411114444111144441111444411111bbb011111bbb1000000000000000000000000000000000000000000000000000000000000000000000000
000000001fff44411444fff11444444114ffff41111bbbb01111bbbb000000000000000000000000000000000000000000000000000000000000000000000000
000000001fbfff4114fffbf11f4444f11fbffbf1111bb0b01111bb1b000000000000000000000000000000000000000000000000000000000000000000000000
000000001ffffff11ffffff11ffffff11ffffff1111bb0111111bb11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011ffff1111ffff1111ffff1111ffff111bbbb01111bbbb11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011bbbb1111bbbb1111bbbb1111bbbb11bbbbb0111bbbbb11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011bfbb1111bbfb111fbbbbf11fbbbbf1bbbbb0111bbbbb11000000000000000000000000000000000000000000000000000000000000000000000000
0000000011bbbb1111bbbb1111bbbb1111bbbb111bbb011111bbb111000000000000000000000000000000000000000000000000000000000000000000000000
00000000114444111144441111444411114444111119990111119991000000000000000000000000000000000000000000000000000000000000000000000000
000000001fff44411444fff11444444114ffff411119999011119999000000000000000000000000000000000000000000000000000000000000000000000000
000000001f9fff4114fff9f11f4444f11f9ff9f11119909011119919000000000000000000000000000000000000000000000000000000000000000000000000
000000001ffffff11ffffff11ffffff11ffffff11119901111119911000000000000000000000000000000000000000000000000000000000000000000000000
0000000011ffff1111ffff1111ffff1111ffff111999901111999911000000000000000000000000000000000000000000000000000000000000000000000000
00000000119999111199991111999911119999119999901119999911000000000000000000000000000000000000000000000000000000000000000000000000
00000000119f99111199f9111f9999f11f9999f19999901119999911000000000000000000000000000000000000000000000000000000000000000000000000
00000000119999111199991111999911119999111999011111999111000000000000000000000000000000000000000000000000000000000000000000000000
00000000004444000044440000444400004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000fff44400444fff00444444004ffff400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000fefff4004fffef00f4444f00feffef00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000ffffff00ffffff00ffffff00ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000ffff0000ffff0000ffff0000ffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000eeee0000eeee0000eeee0000eeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000efee0000eefe000feeeef00feeeef00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000eeee0000eeee0000eeee0000eeee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
011000000c143000000000000000246150000000000000000c143000000000000000246150000000000000000c143000000000000000246150000000000000001814300000000000000024615000000000000000
011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180500000000000000001805000000000000000018050000000000000000
__music__
03 00014344

